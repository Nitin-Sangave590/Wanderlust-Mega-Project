@Library('Shared') _
pipeline {
    agent { label 'Node' }

    parameters {
        string(name: 'FRONTEND_DOCKER_TAG', defaultValue: '', description: 'Frontend Docker tag')
        string(name: 'BACKEND_DOCKER_TAG', defaultValue: '', description: 'Backend Docker tag')
    }

    stages {

        stage("Workspace cleanup") {
            steps {
                cleanWs()
            }
        }

        stage('Git: Code Checkout') {
            steps {
                script {
                    code_checkout(
                        "https://github.com/LondheShubham153/Wanderlust-Mega-Project.git",
                        "main"
                    )
                }
            }
        }

        stage('Verify: Docker Image Tags') {
            steps {
                echo "FRONTEND_DOCKER_TAG: ${params.FRONTEND_DOCKER_TAG}"
                echo "BACKEND_DOCKER_TAG: ${params.BACKEND_DOCKER_TAG}"
            }
        }

        stage("Update: Kubernetes manifests") {
            steps {
                dir('kubernetes') {
                    sh """
                      sed -i "s|image: .*wanderlust-backend-beta.*|image: nitinsangave2025/wanderlust-backend-beta:${params.BACKEND_DOCKER_TAG}|" backend.yaml
                      sed -i "s|image: .*wanderlust-frontend-beta.*|image: nitinsangave2025/wanderlust-frontend-beta:${params.FRONTEND_DOCKER_TAG}|" frontend.yaml
                    """
                }
            }
        }

        stage("Git: Code update and push to GitHub") {
            steps {
                withCredentials([gitUsernamePassword(credentialsId: 'Github-cred', gitToolName: 'Default')]) {
                    sh '''
                      git status
                      git add .
                      git commit -m "Update Docker image tags" || echo "No changes to commit"
                      git push origin main
                    '''
                }
            }
        }
    }

    post {
        success {
            emailext(
                attachLog: true,
                from: 'nitinsangave995@gmail.com',
                to: 'nitinsangave995@gmail.com',
                subject: "Wanderlust Application updated - ${currentBuild.result}",
                mimeType: 'text/html',
                body: """
                <html>
                  <body>
                    <p><b>Project:</b> ${env.JOB_NAME}</p>
                    <p><b>Build:</b> ${env.BUILD_NUMBER}</p>
                    <p><b>URL:</b> ${env.BUILD_URL}</p>
                  </body>
                </html>
                """
            )
        }

        failure {
            emailext(
                attachLog: true,
                from: 'nitinsangave995@gmail.com',
                to: 'nitinsangave995@gmail.com',
                subject: "Wanderlust Application build FAILED",
                mimeType: 'text/html',
                body: """
                <html>
                  <body>
                    <p><b>Project:</b> ${env.JOB_NAME}</p>
                    <p><b>Build:</b> ${env.BUILD_NUMBER}</p>
                  </body>
                </html>
                """
            )
        }
    }
}
